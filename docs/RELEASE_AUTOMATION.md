# Release Automation

This document describes the automated release process for CConductor.

## Overview

When you push a version tag (e.g., `v0.4.0`), GitHub Actions automatically:

1. ✅ Validates the release (VERSION file, CHANGELOG entry)
2. ✅ Builds and publishes Docker images to ghcr.io
3. ✅ Creates GitHub Release with artifacts
4. ✅ Updates Homebrew tap formula

## Prerequisites

### 1. GitHub Personal Access Token (PAT)

For the Homebrew tap automation to work, you need to create a PAT with access to the `homebrew-cconductor` repository.

**Steps:**

1. Go to: https://github.com/settings/tokens/new
2. Name: `HOMEBREW_TAP_TOKEN`
3. Expiration: Choose appropriate expiration (recommend: 1 year)
4. Select scopes:
   - ✅ `repo` (Full control of private repositories)
   - ✅ `workflow` (Update GitHub Action workflows)
5. Click "Generate token"
6. **Copy the token** (you won't be able to see it again!)

### 2. Add Token to Repository Secrets

1. Go to: https://github.com/yaniv-golan/cconductor/settings/secrets/actions
2. Click "New repository secret"
3. Name: `HOMEBREW_TAP_TOKEN`
4. Value: Paste the token you copied
5. Click "Add secret"

## Release Process

### 1. Prepare the Release

```bash
# Ensure you're on the main branch (or release branch)
git checkout v0.4.0  # or main, depending on your workflow

# Update VERSION file
echo "0.4.0" > VERSION

# Update CHANGELOG.md
# Add a new section for [0.4.0] with release notes
vi CHANGELOG.md

# Commit changes
git add VERSION CHANGELOG.md
git commit -m "chore: bump version to 0.4.0"
git push
```

### 2. Create and Push Tag

```bash
# Create tag
git tag v0.4.0

# Push tag (this triggers all automation)
git push origin v0.4.0
```

### 3. What Happens Automatically

#### Docker Build (2-5 minutes)
- Builds multi-platform images (linux/amd64, linux/arm64)
- Tags: `0.4.0`, `0.4`, `0`, `latest`
- Pushes to: `ghcr.io/yaniv-golan/cconductor`

#### GitHub Release (2-3 minutes)
- Creates release artifacts
- Generates SHA256 checksums
- Extracts release notes from CHANGELOG.md

#### Homebrew Formula Update (1-2 minutes)
- Fetches release tarball SHA256
- Updates formula in homebrew-cconductor tap
- Commits and pushes to tap repository

### 4. Verify the Release

After automation completes (usually 5-8 minutes total):

**Check Docker:**
```bash
docker pull ghcr.io/yaniv-golan/cconductor:0.4.0
docker run ghcr.io/yaniv-golan/cconductor:0.4.0 --version
```

**Check Homebrew:**
```bash
brew update
brew upgrade cconductor
cconductor --version
```

**Check GitHub Release:**
- Visit: https://github.com/yaniv-golan/cconductor/releases/latest
- Verify artifacts are attached
- Check release notes

## Troubleshooting

### Homebrew Automation Fails

**Error: "Resource not accessible by integration"**
- Cause: Missing or invalid `HOMEBREW_TAP_TOKEN`
- Fix: Ensure the token is added to repository secrets with correct permissions

**Error: "refusing to allow a Personal Access Token"**
- Cause: Token doesn't have `repo` scope
- Fix: Create a new token with full `repo` access

**Error: "formula syntax invalid"**
- Cause: Formula template has Ruby syntax errors
- Fix: Test formula locally with `ruby -c Formula-cconductor.rb`

### Docker Build Fails

**Error: "failed to solve with frontend dockerfile"**
- Cause: Dockerfile syntax error or missing dependencies
- Fix: Test locally with `docker build -t test .`

**Error: "denied: permission denied"**
- Cause: GitHub Container Registry permissions issue
- Fix: Ensure workflow has `packages: write` permission (already configured)

### Release Validation Fails

**Error: "VERSION file doesn't match tag"**
- Cause: VERSION file wasn't updated before tagging
- Fix: Delete tag, update VERSION, commit, and re-tag

**Error: "CHANGELOG.md missing entry"**
- Cause: CHANGELOG doesn't have a section for the version
- Fix: This is a warning only, but should be fixed for good practice

## Manual Fallback

If automation fails, you can manually update the Homebrew formula:

```bash
# Get the SHA256
curl -sL https://github.com/yaniv-golan/cconductor/archive/v0.4.0.tar.gz | sha256sum

# Clone tap
git clone https://github.com/yaniv-golan/homebrew-cconductor.git
cd homebrew-cconductor

# Update Formula/cconductor.rb
# - Change version in URL
# - Update SHA256

# Commit and push
git add Formula/cconductor.rb
git commit -m "Update cconductor to version 0.4.0"
git push
```

## Workflow Files

- `.github/workflows/release.yml` - Main release workflow (Docker + artifacts)
- `.github/workflows/update-homebrew.yml` - Homebrew tap automation

## Security Notes

1. **HOMEBREW_TAP_TOKEN**: 
   - Scoped to `yaniv-golan/homebrew-cconductor` repository only
   - Never logged or exposed in workflow output
   - Rotated annually (recommended)

2. **GITHUB_TOKEN**:
   - Auto-generated by GitHub Actions
   - Scoped to current workflow run
   - Used for Docker registry and release creation

3. **Credentials**:
   - Never commit `.claude/` directory (in `.gitignore`)
   - Docker images don't contain any credentials
   - Credentials injected at runtime only

## Monitoring

GitHub Actions runs can be monitored at:
- https://github.com/yaniv-golan/cconductor/actions

Each workflow run shows:
- Duration
- Success/failure status
- Detailed logs for each step
- Artifacts produced

## Best Practices

1. **Test Before Release**:
   ```bash
   # Test Docker build
   docker build -t cconductor:test .
   
   # Test formula
   brew install --build-from-source ./Formula-cconductor.rb
   ```

2. **Semantic Versioning**:
   - Major: Breaking changes (e.g., 1.0.0 → 2.0.0)
   - Minor: New features (e.g., 0.3.0 → 0.4.0)
   - Patch: Bug fixes (e.g., 0.3.3 → 0.3.4)

3. **Changelog Entries**:
   - Added: New features
   - Changed: Changes in existing functionality
   - Deprecated: Soon-to-be removed features
   - Removed: Removed features
   - Fixed: Bug fixes
   - Security: Security fixes

4. **Pre-release Testing**:
   - Test with Claude Code CLI authentication
   - Run `./tests/run-all-tests.sh`
   - Verify ShellCheck passes

## Future Enhancements

Potential improvements to consider:

1. **PyPI Distribution**: Automated Python package publishing
2. **Release Notes**: Auto-generate from commit messages
3. **Rollback**: Automated rollback on failed health checks
4. **Notifications**: Slack/Discord notifications on release
5. **Changelog Validation**: Enforce changelog entries before release

